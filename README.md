# SharedNavigation
[理想のMVVM Navigatorを目指した前作(未完成)](https://github.com/MeilCli/Kamihikouki)より理想的なMVVM Navigator作成を目指すリポジトリ

## 設計
Fodyを使いコンパイル時にNavigator関連のCILを埋め込む

```csharp
    internal class View : INavigationView<ViewModel>
    {
        [Navigate(nameof(ViewModel.PopCommand))]
        public static async Task PopAsync(ViewModel viewModel)
        {
            Console.Out.WriteLine("PopAsync");
            await Task.CompletedTask;
        }

        [Navigate(nameof(ViewModel.PushCommand))]
        public async Task PushAsync(ViewModel viewModel)
        {
            Console.Out.WriteLine("PushAsync");
            await Task.CompletedTask;
        }

        public void RegisterNavigationByAutoGenerated(ViewModel viewModel, INavigationAction defaultNavigationAction)
        {
        }
    }

    internal class ViewModel : INavigationViewModel
    {
        [InjectNavigation]
        public INavigationCommand<ViewModel> PushCommand { get; set; } = new NavigationCommand<ViewModel>();

        [InjectNavigation]
        public INavigationCommand<ViewModel> PopCommand { get; set; } = new NavigationCommand<ViewModel>();

        public void RestoreState(byte[] state)
        {
        }

        public byte[] SaveState()
        {
            return new byte[0];
        }
    }
```

こんな感じのソースコードがあったとすると、生成するCILは以下の2箇所となる

- NavigateAttributeが設定されたメソッドを実行するINavigationActionを実装したクラス
- RegisterNavigationByAutoGeneratedメソッドに生成したNavigationActionをViewModelへInjectする処理

その他`CanNavigate`メソッドやデフォルトのNavigationActionを設定できるようにしたかったりと夢はたくさん、速度は最速、コンパイルは遅くなる

### 生成するCIL
要所を抜き出すと以下のようなもの

```
.class nested private auto ansi beforefieldinit '<N>NavigationAction0' // 通常のC#コードでは指定できない名前にする
    extends [System.Runtime]System.Object
    implements [SharedNavigation.NETStandard]SharedNavigation.NETStandard.INavigationAction
{
    .field private initonly class Sample.View view // View層のクラス

    .method public specialname rtspecialname
        instance void .ctor(
            class Sample.View view
        ) cil managed
    {
        // this();
        ldarg.0
        call instance void [System.Runtime]System.Object::.ctor()
        // this.view = view;
        ldarg.0
        ldarg.1
        stfld class Sample.View Sample.View/'<N>NavigationAction0'::view
        // return
        ret
    }

    .method public final hidebysig newslot virtual
        instance class [System.Runtime]System.Threading.Tasks.Task NavigateAsync<.ctor ([SharedNavigation.NETStandard]SharedNAvigation.NETStandard.INavigationViewModel) T>(
            !!T viewModel
        ) cil managed
    {
        .locals(
            [0] class Sample.ViewModel // ViewModel層のクラス
        )
        // if(([0] = (viewModel as ViewModel)) != null)
        ldarg.1
        box !!T
        isinst Sample.ViewModel
        dup // 値の複製
        stloc.0
        brfalse.s IL_001C // falseならIL_0016に飛ぶ

        // return view.PushAsync([0])
        // 対象がinstance methodの場合であってstatic methodなら別の命令が必要
        ldarg.0
        ldfld class Sample.View Sample.View/'<N>NavigationAction0'::view
        ldloc.0
        callvirt instance class [System.Runtime]System.Threading.Tasks.Task Sample.View::PushAsync(class Sample.ViewModel)
        ret

        // return Task.CompletedTask
        IL_001C: call class [System.Runtime]System.Threading.Tasks.Task [System.Runtime]System.Threading.Tasks.Task::get_CompletedTask()
        ret
    }
}
```

```
.method public final hidebysig newslot virtual
    instance void RegisterNavigationByAutoGenerated(
        class Sample.ViewModel viewModel,
        class [SharedNavigation.NETStandard]SharedNavigation.NETSTandard.INavigationAction defaultNavigationAction
    ) cil managed
{
    // viewModel.PushCommand.NavigationAction = new <N>NavigationAction0(this)
    ldarg.1
    callvirt instance class [SharedNavigation.NETStandard]SharedNavigation.NETStandard.INavigationCommand`1<class Sample.ViewModel> Sample.ViewModel::get_PushCommand()
    ldarg.0
    newobj instance void Sample.View/'<N>NavigationAction0'::.ctor(class Sample.View)
    callvirt instance void class [SharedNavigation.NETStandard]SharedNavigation.NETStandard.INavigationCommand`1<class Sample.ViewModel>::set_NavigationAction(class [SharedNavigation.NETStandard]SharedNavigation.NETStandard.INavigationAction)
    // return
    ret
}
```

## License
MIT License.

### Using Library
- [Fody](https://github.com/Fody/Fody), published by MIT License